# Установка

Генератор и обработчик сообщений состоит из одного модуля *msg.py*.
Запускать его можно так:
```
python3 msg.py
```

# Подготовка

Перед запуском генератора сообщений необходимо установить *Redis*. А также
установить [redis-py](https://redis-py.readthedocs.io/en/latest/):
```
pip install redis
```
Лучше это делать в виртуальном окружении.

# Запуск

Генератор сообщений предназначен для запуска из командной строки. Список
поддерживаемых параметров можно получить по ключу *-h*.
```
usage: msg.py [-h] [-c {handle,getErrors,clean}] [-i INTERVAL]
              [-m MAX_INTERVAL] [-n NUMBER] [-t HOST] [-p PORT]

Генератор и обработчик сообщений.

optional arguments:
  -h, --help            show this help message and exit
  -c {handle,getErrors,clean}, --command {handle,getErrors,clean}
                        Выполняемое действие: handle - генерация и обработка
                        сообщений; getErrors - получение сообщений с ошиками;
                        clean - очистка используемых ключей со старыми
                        значениями. Значение по умолчанию: handle
  -i INTERVAL, --interval INTERVAL
                        Интервал между сообщениями (мс). Значение по умолчанию
                        - 500 мс.
  -m MAX_INTERVAL, --max-interval MAX_INTERVAL
                        Maксимальный интервал между сообщениями (мс). Значение
                        по умолчанию - 900 мс.
  -n NUMBER, --number NUMBER
                        Количество генерируемых сообщений. Значение по
                        умолчанию: 100.
  -t HOST, --host HOST  Имя хоста с redis. Значение по умолчанию: localhost
  -p PORT, --port PORT  Порт, на котором redis принимает соединения. Значение
                        по умолчанию: 6379
```
Несколько экземпляров генераторов для тестирования можно получить так:
```
for i in {1..5}; do python ./msg.py -i 1 -m 300 -n 1000000 & done
```
Здесь приложение генерирует сообщение с частотой раз в 1 миллисекунду. Время
максимального интервала между двумя генерациями 300 миллисекунд. Если генератор
превысил это время, то он считается "выключенным из розетки" (при этом он
может просто подвиснуть), и он заменяется новым генератором.

Перед запуском надо убедиться, что в *redis* удалены все используемые ключи со
старыми значениями:
* generator: имя приложения, которое выполняет функции генератора;
* queue: очередь со сгенерированными сообщениями;
* last_index: индекс последнего сгенерированного значения;
* start: время начала сгенерированного сообщения;
* gen_lock: блокировка, используемая при генерации сообщения;
* accept_lock: блокировка, используемая при приёме сообщения;
* errors: очередь для сообщений с ошибками.

Для этого достаточно запустить команду *clean*:
```
python3 ./msg.py -c clean
```
Далее можно запустить несколько экземпляров приложения *msg.py* с
необходимыми параметрами. Текущая версия разработана так, что имя приложения
складывается из имени текущего хоста, на котором происходит запуск, и номера
процесса. По этому номеру процесса можно отследить процесс-генератор. В то же
время процесс-генератор может и обрабатывать сообщения, что видно по выводу в
консоли. Функции генератора может принять на себя другой экземпляр приложения
в двух случаях:
- если он "подвиснет" и будет слишком медленно генерировать сообщения, т.е. не
будет обеспечивать нужной частоты;
- если приложение будет "выключено из розетки", что можно проверить по pid
процесса, отправив команду *kill -9 \<pid\>*.

Поcле запуска можно получить список сообщений с ошибками:
```
python3 ./msg.py -c getErrors
```
При этом сами сообщения будут удалены из *redis*.
